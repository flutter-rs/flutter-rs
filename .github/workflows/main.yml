on: [push, pull_request]

name: Flutter Rust

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: sudo apt-get install libxcb-shape0-dev libxcb-xfixes0-dev

      - name: Install glfw dependencies
        run: sudo apt-get install libgl1-mesa-dev libxxf86vm-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev

      - name: Checkout sources
        uses: actions/checkout@v1

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'dev'

      - name: Install cargo-flutter
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-flutter

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: flutter
          args: test
        env:
          FLUTTER_ENGINE_VERSION: a50f1ef56a05999bfa97a777cca14fd7a00e8454

      - name: Run cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

      - name: Run cargo clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: -- -D warnings

  android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - target: armv7-linux-androideabi
          - target: aarch64-linux-android
          - target: i686-linux-android
          - target: x86_64-linux-android
    steps:
      - name: Install dependencies
        run: sudo apt-get install llvm-dev

      - name: Checkout sources
        uses: actions/checkout@v1

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: ${{ matrix.config.target }}

      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'dev'

      - name: Install cargo-flutter
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-flutter

      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: flutter
          args: --no-flutter build -p flutter-winit --target ${{ matrix.config.target }}
        env:
          FLUTTER_ENGINE_VERSION: a50f1ef56a05999bfa97a777cca14fd7a00e8454
          NDK_HOME: /usr/local/lib/android/sdk/ndk-bundle

  macos:
    runs-on: macos-latest
    steps:
      - name: Install dependencies
        run: brew install llvm

      - name: Checkout sources
        uses: actions/checkout@v1

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'dev'

      - name: Install cargo-flutter
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-flutter

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: flutter
          args: test
        env:
          FLUTTER_ENGINE_VERSION: a50f1ef56a05999bfa97a777cca14fd7a00e8454
          LLVM_CONFIG_PATH: /usr/local/opt/llvm/bin/llvm-config

  ios:
    runs-on: macos-latest
    strategy:
      matrix:
        config:
          - target: armv7-apple-ios
          - target: aarch64-apple-ios
    steps:
      - name: Install dependencies
        run: brew install llvm

      - name: Checkout sources
        uses: actions/checkout@v1

      - name: Install stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          target: ${{ matrix.config.target }}

      - name: Install flutter
        uses: subosito/flutter-action@v1
        with:
          channel: 'dev'

      - name: Install cargo-flutter
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-flutter

      - name: Build
        uses: actions-rs/cargo@v1
        with:
          command: flutter
          args: --no-flutter build -p flutter-winit --target ${{ matrix.config.target }}
        env:
          FLUTTER_ENGINE_VERSION: a50f1ef56a05999bfa97a777cca14fd7a00e8454
          LLVM_CONFIG_PATH: /usr/local/opt/llvm/bin/llvm-config



